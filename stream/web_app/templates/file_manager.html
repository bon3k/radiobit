<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>file manager</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">log out</a>
    </div>
    <div class="container mt-4">
        <h1>file manager</h1>
        <p>current directory: <strong>{{ current_path }}</strong></p>

        {% if has_audio or has_m3u %}
        <div class="mb-3">
            <button class="btn btn-sm btn-warning" id="recreateBtn">â™» Recreate playlist</button>

            {% if has_m3u %}
                <button class="btn btn-sm btn-info" id="shuffleBtn">ğŸ”€ Shuffle playlist</button>
            {% endif %}
        </div>
        {% endif %}

        {% if parent_path %}
            <a href="{{ url_for('file_manager', path=parent_path) }}" class="btn btn-secondary">â¬†</a>
        {% endif %}
        
        <hr>

        <ul class="list-group">
            {% for item in items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% if item.is_dir %}
                        <a href="{{ url_for('file_manager', path=item.path) }}">ğŸ“ {{ item.name }}</a>
                        <button class="btn btn-sm btn-danger delete-button" data-path="{{ item.path }}" data-folder="true">âœ—</button>
                    {% else %}
                        ğŸ“„ {{ item.name }}
                        <div>
                            <a href="{{ url_for('download_file', path=item.path) }}" class="btn btn-sm btn-primary">â‡©</a>
                            <button class="btn btn-sm btn-danger delete-button" data-path="{{ item.path }}" data-folder="false">âœ—</button>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <hr>
        <h3>ğŸ“¤</h3>
        <form action="{{ url_for('upload_file', path=current_path) }}" method="POST" enctype="multipart/form-data">
            <label><strong>File:</strong></label>
            <input type="file" name="files" class="form-control mb-2" multiple>

            <label class="mt-3"><strong>Directory:</strong></label>
            <input type="file" name="files" class="form-control mb-2" webkitdirectory directory multiple>

    <button type="submit" class="btn btn-success mt-3">Upload</button>
        </form>


    </div>

    <script>
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function () {
                const filePath = this.dataset.path;
                const isFolder = this.dataset.folder === 'true';
                const message = isFolder
                    ? "Â¿Seguro que deseas eliminar esta carpeta y todo su contenido?"
                    : "Â¿Seguro que deseas eliminar este archivo?";

                if (confirm(message)) {
                    fetch('/delete_file?path=' + encodeURIComponent(filePath), { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(isFolder ? "Carpeta eliminada" : "Archivo eliminado");
                                location.reload();
                            } else {
                                alert("Error: " + data.error);
                            }
                        })
                        .catch(error => {
                            console.error("Error en la solicitud:", error);
                            alert("Error de red o del servidor.");
                        });
                }
            });
        });

        // --- Playlist actions ---
        document.getElementById("recreateBtn")?.addEventListener("click", () => {
            fetch("/recreate_m3u", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: "path={{ current_path }}"
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert("Playlist recreated (" + d.tracks + " tracks)");
                    location.reload();
                }
            });
        });

        document.getElementById("shuffleBtn")?.addEventListener("click", () => {
            fetch("/shuffle_m3u", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: "path={{ current_path }}"
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert("Playlist shuffled");
                    location.reload();
                }
            });
        });
    </script>
</body>
</html>
